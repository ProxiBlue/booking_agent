version: '1.4.2'
appVersion: latest
type: install
id: pb_booking_agent
name: BookingAgent
baseUrl: https://raw.githubusercontent.com/ProxiBlue/booking_agent
logo: /images/logo-transparent.png
homepage: http://www.proxiblue.com.au/

categories:
- apps/dev-and-admin-tools

description:
  text: /texts/description.md
  short: Open-source PHP web framework for rapid development

globals:
  webroot: /var/www/webroot/ROOT
  NGINX_PASS: ${fn.password(10)}
  MONIT_PASS: ${fn.password(10)}
  PHP_VERSION: 1.28.0-php-8.4.7-almalinux-9

ssl: true
skipNodeEmails: true

nodes:
- cloudlets: 16
  nodeType: nginxphp-dockerized
  tag: ${globals.PHP_VERSION}
  extip: 1
  nodeGroup: cp
  volumes:
      - /var/www/webroot/ROOT
  displayName: AppServer
  env:
    PHPFPM_MAX_CHILDREN: 1000
    REDIS_ENABLED: 1
    REDIS_VERSION: 6.0.6

onInstall:
    - SetupAccess
    - config
    - install
    - restartNodes:
        - nodeGroup: [cp]

actions:
    SetupAccess:
      - log: Set Access
      - cmd [cp]: |-
          echo ${globals.NGINX_PASS}| passwd --stdin nginx &>> /var/log/run.log
          echo ${globals.NGINX_PASS}| passwd --stdin root &>> /var/log/run.log
          usermod -aG wheel nginx &>> /var/log/run.log
          echo "nginx ALL=(ALL) ALL" > /etc/sudoers.d/nginx
          chmod 0440 /etc/sudoers.d/nginx
        user: root
        sayYes: true
    config:
      cmd[cp]: |-
        curl -fsSL https://getcomposer.org/installer | php
        mv composer.phar /usr/bin/composer
        chmod +x /usr/bin/composer
        cd ${globals.webroot}
        yum install -y epel-release &>> /var/log/run.log
        yum update -y &>> /var/log/run.log
        yum install -y joe pv monit libsodium httpd-tools &>> /var/log/run.log
      user: root
      sayYes: true
    install:
      cmd[cp]:
        - touch /var/log/run.log
        - chmod 777 /var/log/run.log
        - sed -i -e "/use address localhost/d" /etc/monitrc
        - sed -i -e "/allow localhost/d" /etc/monitrc
        - sed -i -e "s/allow admin:monit/allow admin:${globals.MONIT_PASS}/g" /etc/monitrc
        - export REDIS_ENABLED=TRUE
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/redis.conf -o /etc/redis.conf
        - systemctl start redis &>> /var/log/run.log
        - systemctl enable redis &>> /var/log/run.log
        - systemctl restart nginx &>> /var/log/run.log
        - jem service restart  &>> /var/log/run.log
        - mkdir -p /etc/monit.d/
        - rm -f /etc/monit.d/* &>> /var/log/run.log
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/monit.d/nginx -o /etc/monit.d/nginx
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/monit.d/phpfpm -o /etc/monit.d/phpfpm
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/monit.d/booking_queue -o /etc/monit.d/booking_queue
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/php.d/assert_off.ini -o /etc/php.d/assert_off.ini
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/php.d/custom_io.ini -o /etc/php.d/custom_io.ini
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/php.d/error_level.ini -o /etc/php.d/error_level.ini
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/php-fpm.conf -o /etc/php-fpm.conf
        - mkdir -p /etc/systemd/system/redis.service.d/
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/etc/systemd/system/redis.service.d/restart.conf -o /etc/systemd/system/redis.service.d/restart.conf
        - systemctl daemon-reload &>> /var/log/run.log
        - systemctl enable monit &>> /var/log/run.log
        - systemctl start monit &>> /var/log/run.log
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/usr/local/bin/check-redis-queue.sh -o /usr/local/bin/check-redis-queue.sh
        - chmod +x /usr/local/bin/check-redis-queue.sh
        - curl -fsSL https://raw.githubusercontent.com/ProxiBlue/booking_agent/main/usr/local/bin/worker.php -o /usr/local/bin/worker.php
        - chmod +x /usr/local/bin/worker.php
        - grep -qxF 'include /etc/monit.d/*' /etc/monitrc || echo "include /etc/monit.d/*" >> /etc/monitrc
        - monit reload &>> /var/log/run.log
      user: root
      sayYes: true
    setupFirewall:
      - api: env.security.AddRule
        rule:
          direction: INPUT
          name: Monit Access
          protocol: TCP
          ports: 2812
          src: 180.150.92.24/32
          priority: 1100
          action: ALLOW
      - api: env.security.AddRule
        rule:
          direction: INPUT
          name: Block FTP
          protocol: TCP
          ports: 20,21
          src: 0.0.0.0/0
          priority: 1200
          action: DENY
      - api: env.security.AddRule
        rule:
          direction: INPUT
          name: Block SMTP
          protocol: TCP
          ports: 25
          src: 0.0.0.0/0
          priority: 1200
          action: DENY
success:
  text: |

    ## Redis for Cache

    * **Host**: ${nodes.cp.first.intIP} or just use: localhost on AppServer
    * **socket**: It is preferred to use the socket /tmp/redis.sock

    ## AppServer Node

    * **password**: ${globals.NGINX_PASS}

    ## MONIT on port 2812

        * admin / ${globals.MONIT_PASS}

    * queue worker is managed by monit
    * open the monit port!