version: '1.4.2'
appVersion: latest
type: install
id: pb_booking_agent
name: BookingAgent
baseUrl: https://raw.githubusercontent.com/ProxiBlue/booking_agent
logo: /images/logo-transparent.png
homepage: http://www.proxiblue.com.au/

categories:
- apps/dev-and-admin-tools

description:
  text: /texts/description.md
  short: Open-source PHP web framework for rapid development

globals:
  webroot: /var/www/webroot/ROOT
  NGINX_PASS: ${fn.password(10)}
  STATS_PASS: ${fn.password(10)}
  MONIT_PASS: ${fn.password(10)}
  NODE_VERSION: 1.28.0-php-8.4.7-almalinux-9

ssl: true
skipNodeEmails: true

nodes:
- cloudlets: 16
  nodeType: nginxphp-dockerized
  tag: ${settings.NODE_VERSION}
  extip: 1
  nodeGroup: cp
  volumes:
      - /var/www/webroot/ROOT
  displayName: AppServer
  env:
    PHPFPM_MAX_CHILDREN: 1000
    REDIS_ENABLED: 1
    REDIS_VERSION: 6.0.6

onInstall:
    - SetupAccess
    - config
    - install
    - restartNodes:
        - nodeGroup: [cp]

actions:
    SetupAccess:
      - log: Set Access
      - cmd [cp]: |-
          echo ${globals.NGINX_PASS}| passwd --stdin nginx &>> /var/log/run.log
          echo ${globals.NGINX_PASS}| passwd --stdin root &>> /var/log/run.log
        user: root
        sayYes: true
    config:
      cmd[cp]: |-
        curl -sS https://getcomposer.org/installer | php
        mv composer.phar /usr/bin/composer
        chmod +x /usr/bin/composer
        cd ${globals.webroot}
        yum install epel-release &>> /var/log/run.log
        yum update
        yum install -y joe pv monit libsodium httpd-tools &>> /var/log/run.log
      user: root
      sayYes: true
    install:
      cmd[cp]:
        - htpasswd -b -c /etc/nginx/.htpasswd stats ${globals.STATS_PASS}
        - chown nginx:nginx /etc/nginx/.htpasswd
        - sed -i -e "/use address localhost/d" /etc/monitrc
        - sed -i -e "/allow localhost/d" /etc/monitrc
        - sed -i -e "s/allow admin:monit/allow admin:${globals.MONIT_PASS}/g" /etc/monitrc
        - export REDIS_ENABLED=TRUE
        - curl etc/redis.conf > /etc/redis.conf
        - systemctl start redis &>> /var/log/run.log
        - systemctl enable redis &>> /var/log/run.log
        - systemctl restart nginx &>> /var/log/run.log
        - jem service restart  &>> /var/log/run.log
        - mkdir -p /etc/monit.d/
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/monit/nginx > /etc/monit.d/nginx
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/monit/nginx > /etc/monit.d/nginx
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/monit/booking_agent > /etc/monit.d/booking_agent
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/php.d/assert_off.ini > /etc/php.d/assert_off.ini
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/php.d/custom_io.ini > /etc/php.d/custom_io.ini
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/php.d/error_level.ini > /etc/php.d/error_level.ini
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/php.d/assert_off.ini > /etc/php.d/assert_off.ini
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/php-fpm.conf > /etc/php-fpm.conf
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/configs/nginx/CORS-CDN/cors.conf > /etc/nginx/conf.d/CORS/cors.conf
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/configs/nginx/stub_status.conf > /etc/nginx/conf.d/stub_status.conf
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main/etc/systemd/system/redis.service.d/restart.conf > /etc/systemd/system/redis.service.d/restart.conf
        - systemctl enable monit &>> /var/log/run.log
        - systemctl start monit &>> /var/log/run.log
        - systemctl daemon-reload &>> /var/log/run.log
        - curl https://raw.githubusercontent.com/ProxiBlue/HostingEnvironment/main//usr/local/bin/check-redis-queue.sh > /usr/local/bin/check-redis-queue.sh
        - chmod +x /usr/local/bin/check-redis-queue.sh
      user: root
      sayYes: true
success: /texts/success.md
