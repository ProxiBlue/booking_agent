# /etc/monit/conf.d/ai-assistant-worker
#
# Direct Monit management of worker process (no systemd required)

###############################################################################
# Message Queue Worker Process Monitoring
###############################################################################

check process booking_queue
    matching "worker.php"

    # Direct PHP execution (no systemd)
    start program = "/usr/bin/php /usr/local/bin/worker.php"
        as uid "nginx" gid "nginx"
        with timeout 60 seconds

    stop program = "/usr/bin/pkill -f 'php.*worker.php'"
        with timeout 30 seconds

    # Restart if process doesn't exist
    if does not exist then restart

    # Restart if using too much memory (adjust as needed)
    if memory > 512 MB for 3 cycles then restart

    # Restart if using too much CPU (adjust as needed)
    if cpu > 80% for 5 cycles then restart

    # Alert if worker keeps restarting (possible crash loop)
    if 5 restarts within 5 cycles then alert

    # Check every 30 seconds (uses global setting)

    # Dependencies: restart if Redis is restarted
    depends on redis-server

    group workers


###############################################################################
# Redis Server Monitoring
###############################################################################

check process redis-server
    with pidfile /var/run/redis_6379.pid
    start program = "/usr/bin/redis-server /etc/redis/redis.conf"
        with timeout 60 seconds
    stop program = "/usr/bin/redis-cli shutdown"
        with timeout 30 seconds

    # Restart if process doesn't exist
    if does not exist then restart

    # Check if Redis is responding
    if failed host 127.0.0.1 port 6379 protocol redis then restart

    # Memory monitoring
    if memory > 1 GB then alert
    if memory > 2 GB then restart

    # Alert if Redis keeps restarting
    if 3 restarts within 5 cycles then alert

    group services


###############################################################################
# Redis Queue Length Monitoring
###############################################################################

check program redis-queue-length
    with path "/usr/local/bin/check-redis-queue.sh"
    every 5 cycles  # Check every 2.5 minutes (5 * 30 seconds)
    if status > 0 then alert
    group monitoring
